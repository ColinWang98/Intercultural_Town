# NPC 对话选择系统 - 快速参考

## 🎯 核心概念

```
玩家 → 靠近 NPC → 系统检测附近其他 NPC → 显示选择UI → 玩家选择 → 后端创建对话 → 显示群聊
```

---

## 📁 文件结构

```
godot_2d_example/
├── npc_persona_interactive.gd      # 主脚本（替换 npc_persona_2d_group.gd）
├── npc_chat_selector.gd            # 可选：高级 NPC 选择器
├── chat_selector_ui.gd              # UI 界面
├── NPC_CHAT_SELECTION_GUIDE.md     # 完整指南
└── NPC_CHAT_WORKFLOW.md            # 本文件
```

---

## 🎮 三种对话模式

### 模式 1: Auto（自动）

```
玩家靠近 NPC1 + NPC2
    ↓
自动检测到附近有其他 NPC
    ↓
显示提示："按 E 选择对话对象"
    ↓
玩家按 E
    ↓
打开选择 UI
```

### 模式 2: Manual（手动）

```
玩家靠近 NPC
    ↓
显示"选择对话"按钮
    ↓
玩家点击按钮
    ↓
打开选择 UI
```

### 模式 3: None（禁用）

```
玩家靠近 NPC
    ↓
普通单人对话
```

---

## 🔄 完整流程图

```
┌──────────────────────────────────────────────┐
│ 1. 玩家进入 NPC 检测范围                     │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 2. NPC 检测附近的其他 NPC（150px 半径）      │
│    - 查找所有 "npcs" 组中的节点              │
│    - 计算距离                                │
│    - 过滤超出范围的                          │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 3. 判断聊天模式                              │
├──────────────────────────────────────────────┤
│ Auto → 显示提示"按 E 选择"                   │
│ Manual → 显示按钮                             │
│ None → 不显示任何提示                         │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 4. 玩家触发选择 UI                            │
│    - 按 E 键（Auto 模式）                     │
│    - 点击按钮（Manual 模式）                  │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 5. 显示选择器 UI                              │
│  ┌─────────────────────────────────────┐    │
│  │  选择对话对象                         │    │
│  ├─────────────────────────────────────┤    │
│  │ ☐ NPC1 (自己)                       │    │
│  │ ☑ NPC2                              │    │
│  │ ☑ NPC3                              │    │
│  │ ☐ NPC4                              │    │
│  ├─────────────────────────────────────┤    │
│  │    [开始对话]    [取消]             │    │
│  └─────────────────────────────────────┘    │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 6. 玩家选择 2+ 个 NPC                        │
│    - 至少选择 2 个                           │
│    - 可以全选                                │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 7. 发送请求到后端                             │
│    POST /conversations                       │
│    {                                         │
│      "persona_ids": ["npc1", "npc2", ...]    │
│    }                                         │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 8. 后端返回对话                               │
│    {                                         │
│      "id": "conv_id",                        │
│      "messages": [                           │
│        {"role": "model", "name": "NPC1", ...},│
│        {"role": "model", "name": "NPC2", ...} │
│      ]                                       │
│    }                                         │
└──────────────────┬───────────────────────────┘
                   ↓
┌──────────────────────────────────────────────┐
│ 9. 显示对话气泡                               │
│    - 使用 Dialogue Manager                    │
│    - 显示所有 NPC 的发言                      │
└──────────────────────────────────────────────┘
```

---

## 🎨 UI 示例

### 选择器界面

```
┌──────────────────────────┐
│    选择对话对象           │ ← 标题
├──────────────────────────┤
│ ☐ Mikko (自己)          │ ← 自己默认不选
│ ☑ Mark                  │ ← 复选框
│   (150px)               │ ← 距离
├──────────────────────────┤
│ ☑ Colin                 │
│   (80px)                │
├──────────────────────────┤
│ ☐ Emma                  │
│   (200px)               │
├──────────────────────────┤
│  [开始对话]    [取消]     │ ← 按钮
└──────────────────────────┘
```

---

## ⚙️ Inspector 配置速查

### 基础配置

```
NPC (Node2D)
├─ Script: npc_persona_interactive.gd
├─ Persona Id: mikko
├─ Persona Name: Mikko
├─ Chat Mode: Auto/Manual/None
└─ Show Chat Indicator: true
```

### 高级配置（如果有）

```
NPC (Node2D)
├─ Can Initiate Chat: true
├─ NPC Detection Radius: 200.0
└─ Chat Preference: All/Friends/Similar/Random
```

---

## 🔗 API 调用示例

### 请求

```http
POST /conversations
Content-Type: application/json

{
  "persona_ids": ["mikko", "mark", "colin"],
  "dynamic_personas": [...]
}
```

### 响应

```json
{
  "id": "abc123",
  "persona_ids": ["mikko", "mark", "colin"],
  "messages": [
    {"role": "model", "name": "Mikko", "content": "Moi! ..."},
    {"role": "model", "name": "Mark", "content": "Hey! ..."},
    {"role": "model", "name": "Colin", "content": "Oh hello..."}
  ]
}
```

---

## 💡 常用代码片段

### 检查附近 NPC 数量

```gdscript
var nearby = _find_nearby_npcs()
print("附近有 %d 个 NPC" % nearby.size())
```

### 手动触发对话

```gdscript
# 直接开始对话，不显示 UI
_start_group_chat(["mikko", "mark"])
```

### 自定义检测范围

```gdscript
# 修改 _find_nearby_npcs()
if distance <= 300.0:  # 改为 300 像素
```

---

## 🐛 常见问题

### Q: 提示不显示？
A: 检查：
- `chat_mode` 是否设置为 "Auto"
- 是否有其他 NPC 在附近（150px 内）
- NPC 是否在 "npcs" 组中

### Q: 选择器 UI 不显示？
A: 检查：
- `chat_selector_ui.tscn` 是否存在
- 是否有错误日志
- 尝试使用 `Manual` 模式

### Q: 对话没有开始？
A: 检查：
- 后端是否运行（`http://127.0.0.1:8000`）
- `persona_id` 是否正确
- 是否选择了至少 2 个 NPC

---

## 📚 相关文档

- `DYNAMIC_PERSONA_EXTENDED_GUIDE.md` - 动态 Persona 完整指南
- `README_ARCHITECTURE.md` - 项目架构说明
- Main.py → `create_conversation()` - 后端 API 实现

---

## 🎯 下一步

1. **测试基础功能**
   - 创建 2-3 个 NPC
   - 设置不同的 `chat_mode`
   - 测试选择对话

2. **添加动态 Persona**
   - 配置 `personality_type`
   - 添加 `likes`/`dislikes`
   - 观察对话差异

3. **扩展功能**
   - 添加 NPC 好感度系统
   - 实现对话历史记录
   - 添加 NPC 主动发起对话
